// Copyright (C) 2012 Winterleaf Entertainment L,L,C.
// 
// THE SOFTW ARE IS PROVIDED ON AN “ AS IS” BASIS, WITHOUT W ARRANTY OF ANY KIND,
// INCLUDING WITHOUT LIMIT ATION THE W ARRANTIES OF MERCHANT ABILITY, FITNESS
// FOR A PARTICULAR PURPOSE OR NON-INFRINGEMENT . THE ENTIRE RISK AS TO THE
// QUALITY AND PERFORMANCE OF THE SOFTW ARE IS THE RESPONSIBILITY OF LICENSEE.
// SHOULD THE SOFTW ARE PROVE DEFECTIVE IN ANY RESPECT , LICENSEE AND NOT LICEN -
// SOR OR ITS SUPPLIERS OR RESELLERS ASSUMES THE ENTIRE COST OF AN Y SERVICE AND
// REPAIR. THIS DISCLAIMER OF W ARRANTY CONSTITUTES AN ESSENTIAL PART OF THIS
// AGREEMENT. NO USE OF THE SOFTW ARE IS AUTHORIZED HEREUNDER EXCEPT UNDER
// THIS DISCLAIMER.
// 
// The use of the WinterLeaf Entertainment LLC DotNetT orque (“DNT ”) and DotNetT orque
// Customizer (“DNTC”)is governed by this license agreement (“ Agreement”).
// 
// R E S T R I C T I O N S
// 
// (a) Licensee may not: (i) create any derivative works of DNTC, including but not
// limited to translations, localizations, technology add-ons, or game making software
// other than Games; (ii) reverse engineer , or otherwise attempt to derive the algorithms
// for DNT or DNTC (iii) redistribute, encumber , sell, rent, lease, sublicense, or otherwise
// transfer rights to  DNTC; or (iv) remove or alter any tra demark, logo, copyright
// or other proprietary notices, legends, symbols or labels in DNT or DNTC; or (iiv) use
// the Software to develop or distribute any software that compete s with the Software
// without WinterLeaf Entertainment’s prior written consent; or (i iiv) use the Software for
// any illegal purpose.
// (b) Licensee may not distribute the DNTC in any manner.
// 
// LI C E N S E G R A N T .
// This license allows companies of any size, government entities or individuals to cre -
// ate, sell, rent, lease, or otherwise profit commercially from, games using executables
// created from the source code of DNT
// 
// **********************************************************************************
// **********************************************************************************
// **********************************************************************************
// THE SOURCE CODE GENERATED BY DNTC CAN BE  DISTRIBUTED PUBLICLY PROVIDED THAT THE 
// DISTRIBUTOR PROVIDES  THE GENERATE SOURCE CODE FREE OF CHARGE.
// 
// THIS SOURCE CODE (DNT) CAN BE DISTRIBUTED PUBLICLY PROVIDED THAT THE DISTRIBUTOR 
// PROVIDES  THE SOURCE CODE (DNT) FREE OF CHARGE.
// **********************************************************************************
// **********************************************************************************
// **********************************************************************************
// 
// Please visit http://www.winterleafentertainment.com for more information about the project and latest updates.
// 
// 
// 

#region

using System;
using System.Collections.Generic;
using WinterLeaf.Classes;
using WinterLeaf.tsObjects;

#endregion

namespace DNT_FPS_Demo_Game_Dll.Scripts.Client
    {
    //-----------------------------------------------------------------------------
    // Torque
    // Copyright GarageGames, LLC 2011
    //-----------------------------------------------------------------------------

    //----------------------------------------------------------------------------
    // Game start / end events sent from the server
    //----------------------------------------------------------------------------
    public partial class Main : TorqueScriptTemplate
        {
        //-----------------------------------------------------------------------------
        // Torque
        // Copyright GarageGames, LLC 2011
        //-----------------------------------------------------------------------------

        //----------------------------------------------------------------------------
        // Mission Loading & Mission Info
        // The mission loading server handshaking is handled by the
        // core/scripts/client/missingLoading.cs.  This portion handles the interface
        // with the game GUI.
        //----------------------------------------------------------------------------

        //----------------------------------------------------------------------------
        // Loading Phases:
        // Phase 1: Download Datablocks
        // Phase 2: Download Ghost Objects
        // Phase 3: Scene Lighting

        //----------------------------------------------------------------------------
        // Phase 1
        //----------------------------------------------------------------------------
        public List<string> MLoadinfo = new List<string>();

        [Torque_Decorations.TorqueCallBack("", "", "MissionDownload_init", "", 0, 8000, true)]
        public void MissionDownload_init()
            {
            console.Eval("addMessageCallback( 'MsgLoadInfo', handleLoadInfoMessage );");
            console.Eval("addMessageCallback( 'MsgLoadDescripition', handleLoadDescriptionMessage );");
            console.Eval("addMessageCallback( 'MsgLoadInfoDone', handleLoadInfoDoneMessage );");
            console.Eval("addMessageCallback( 'MsgLoadFailed', handleLoadFailedMessage );");
            }


        [Torque_Decorations.TorqueCallBack("", "", "onMissionDownloadPhase1", "(%missionName, %musicTrack)", 2, 8000, false)]
        public void onMissionDownloadPhase1(string missionName, string musicTrack)
            {
            console.print("------------>onMissionDownloadPhase1('" + missionName + "', '" + musicTrack + "')");
            // Load the post effect presets for this mission.
            string path = "levels/" + Util.fileBase(missionName) + console.GetVarString("$PostFXManager::fileExtension");

            if (console.Call("isScriptFile", new[] { path }).AsBool())
                PostFXManagerloadPresetHandler(path);
            else
                PostFXManagersettingsApplyDefaultPreset("PostFXManager");

            // Close and clear the message hud (in case it's open)

            coGuiControl MessageHud = "MessageHud";
            if (MessageHud.isObject())
                MessageHud.call("close");

            // Reset the loading progress controls:

            coGuiControl LoadingProgress = "LoadingProgress";
            if (LoadingProgress.isObject())
                {
                ((coGuiControl)"LoadingProgress").setValue("0");
                ((coGuiTextCtrl)"LoadingProgressTxt").setValue("LOADING DATABLOCKS");
                ((coGuiCanvas)"canvas").repaint(0);
                }
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase1Progress", "(%progress)", 1, 8000, false)]
        public void onPhase1Progress(string progress)
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue(progress);
            ((coGuiCanvas)"canvas").repaint(33);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase1Complete", "()", 0, 8000, false)]
        public void onPhase1Complete()
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue("1");
            ((coGuiCanvas)"canvas").repaint(33);
            }


        //----------------------------------------------------------------------------
        // Phase 2
        //----------------------------------------------------------------------------
        [Torque_Decorations.TorqueCallBack("", "", "onMissionDownloadPhase2", "()", 0, 8000, false)]
        public void onMissionDownloadPhase2()
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue("0");
            ((coGuiTextCtrl)"LoadingProgressTxt").setValue("LOADING OBJECTS");
            ((coGuiCanvas)"canvas").repaint(0);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase2Progress", "(%progress)", 1, 8000, false)]
        public void onPhase2Progress(string progress)
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue(progress);
            //((coGuiTextCtrl)"LoadingProgressTxt").setValue(progress);
            ((coGuiCanvas)"canvas").repaint(33);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase2Complete", "()", 0, 8000, false)]
        public void onPhase2Complete()
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue("1");
            ((coGuiCanvas)"canvas").repaint(0);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onFileChunkReceived", "(%fileName, %ofs, %size)", 3, 8000, false)]
        public void onFileChunkReceived(string filename, string ofs, string size)
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue((ofs.AsDouble() / size.AsDouble()).ToString("0.0"));
            ((coGuiTextCtrl)"LoadingProgressTxt").setValue("Downloading " + filename + ".... ");
            ((coGuiCanvas)"canvas").repaint(0);
            }

        //----------------------------------------------------------------------------
        // Phase 3
        //----------------------------------------------------------------------------

        [Torque_Decorations.TorqueCallBack("", "", "onMissionDownloadPhase3", "()", 0, 8000, false)]
        public void onMissionDownloadPhase3()
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue("0");
            ((coGuiTextCtrl)"LoadingProgressTxt").setValue("LIGHTING MISSION");
            ((coGuiCanvas)"canvas").repaint(0);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase3Progress", "(%progress)", 1, 8000, false)]
        public void onPhase3Progress(string progress)
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (!LoadingProgress.isObject())
                return;
            LoadingProgress.setValue(progress);
            ((coGuiCanvas)"canvas").repaint(33);
            }

        [Torque_Decorations.TorqueCallBack("", "", "onPhase3Complete", "()", 0, 8000, false)]
        public void onPhase3Complete()
            {
            coGuiControl LoadingProgress = "LoadingProgress";
            if (LoadingProgress.isObject())
                {
                ((coGuiTextCtrl)"LoadingProgressTxt").setValue("STARTING MISSION");
                LoadingProgress.setValue("1");
                ((coGuiCanvas)"canvas").repaint(0);
                }

            bGlobal["$lightingMission"] = false;
            }

        [Torque_Decorations.TorqueCallBack("", "", "onMissionDownloadComplete", "()", 0, 8000, false)]
        public void onMissionDownloadComplete()
            {
            init_Default_Bind();
            // Client will shortly be dropped into the game, so this is
            // good place for any last minute gui cleanup.
            }

        [Torque_Decorations.TorqueCallBack("", "", "handleLoadInfoMessage", "( %msgType, %msgString, %mapName ) ", 3, 8000, false)]
        public void handleLoadInfoMessage(string msgType, string msgString, string mapname)
            {
            console.error("Load info Recieved map " + mapname);


            coGuiChunkedBitmapCtrl LoadingGui = "LoadingGui";
            if (((coGuiCanvas)"canvas").getContent() != LoadingGui.getId())
                LoadLoadingGui("LOADING MISSION FILE " + mapname);


            if (mapname.Trim() != "")
                MLoadinfo.Clear();
            MLoadinfo.Add("LOADING MISSION FILE " + mapname);
            for (int line = 0; line < LoadingGui["qLineCount"].AsInt(); line++)
                {
                LoadingGui["qLine[" + line.AsString() + "]"] = "";
                LoadingGui["qLineCount"] = (line + 1).AsString();
                }
            }


        [Torque_Decorations.TorqueCallBack("", "", "handleLoadDescriptionMessage", "( %msgType, %msgString, %line ) ", 3, 8000, false)]
        public void handleLoadDescriptionMessage(string msgType, string msgString, string line)
            {
            coGuiChunkedBitmapCtrl LoadingGui = "LoadingGui";

            MLoadinfo.Add(line);

            int l = LoadingGui["qLineCount"].AsInt();
            LoadingGui["qLine[" + l.AsString() + "]"] = line;
            l++;
            LoadingGui["qLineCount"] = l.AsString();
            }

        [Torque_Decorations.TorqueCallBack("", "", "handleLoadInfoDoneMessage", "( %msgType, %msgString ) ", 2, 8000, false)]
        public void handleLoadInfoDoneMessage(string msgType, string msgString)
            {
            // This will get called after the last description line is sent.
            //onServerMessage
            foreach (string line in MLoadinfo)
                {
                OnServerMessage(line);
                }
            }

        [Torque_Decorations.TorqueCallBack("", "", "handleLoadFailedMessage", "( %msgType, %msgString ) ", 2, 8000, false)]
        public void handleLoadFailedMessage(string msgType, string msgString)
            {
            console.Call("MessageBoxOk", new[] { "Mission Load Failed", msgString + "\r\nPress OK to return to the Main Menu", "disconnect();" });
            }


        //-------------------------------------

        //----------------------------------------------------------------------------
        // Mission Loading
        // Server download handshaking.  This produces a number of onPhaseX
        // calls so the game scripts can update the game's GUI.
        //
        // Loading Phases:
        // Phase 1: Download Datablocks
        // Phase 2: Download Ghost Objects
        // Phase 3: Scene Lighting
        //----------------------------------------------------------------------------

        //----------------------------------------------------------------------------
        // Phase 1 
        //----------------------------------------------------------------------------


        [Torque_Decorations.TorqueCallBack("", "", "clientCmdMissionStartPhase1", "(%seq, %missionName, %musicTrack)", 3, 52000, false)]
        public void clientCmdMissionStartPhase1(string seq, string missionName, string musicTrack)
            {
            console.print("*** New Mission: " + missionName);
            console.print("*** Phase 1: Download Datablocks & Targets");
            onMissionDownloadPhase1(missionName, musicTrack);
            console.print("------------>MissionStartPhase1Ack");
            console.commandToServer("MissionStartPhase1Ack", new[] { seq });
            }

        [Torque_Decorations.TorqueCallBack("", "", "onDataBlockObjectReceived", "(%index, %total)", 2, 52000, false)]
        public void onDataBlockObjectReceived(string index, string total)
            {
            onPhase1Progress((index.AsDouble() / total.AsDouble()).AsString());
            }

        //----------------------------------------------------------------------------
        // Phase 2
        //----------------------------------------------------------------------------

        [Torque_Decorations.TorqueCallBack("", "", "clientCmdMissionStartPhase2", "(%seq,%missionName)", 2, 52000, false)]
        public void clientCmdMissionStartPhase2(string seq, string missionName)
            {
            onPhase1Complete();
            console.print("*** Phase 2: Download Ghost Objects");
            onMissionDownloadPhase2();
            console.commandToServer("MissionStartPhase2Ack", new[] { seq, sGlobal["$pref::Player:PlayerDB"] });
            }

        [Torque_Decorations.TorqueCallBack("", "", "onGhostAlwaysStarted", "(%ghostCount)", 1, 52000, false)]
        public void onGhostAlwaysStarted(string ghostCount)
            {
            sGlobal["$ghostCount"] = ghostCount;
            iGlobal["$ghostsRecvd"] = 0;
            }

        [Torque_Decorations.TorqueCallBack("", "", "onGhostAlwaysObjectReceived", "()", 0, 52000, false)]
        public void onGhostAlwaysObjectReceived()
            {
            iGlobal["$ghostsRecvd"] = iGlobal["$ghostsRecvd"] + 1;
            onPhase2Progress((fGlobal["$ghostsRecvd"] / fGlobal["$ghostCount"]).AsString());
            }

        //----------------------------------------------------------------------------
        // Phase 3
        //----------------------------------------------------------------------------

        [Torque_Decorations.TorqueCallBack("", "", "clientCmdMissionStartPhase3", "(%seq,%missionName)", 2, 52000, false)]
        public void clientCmdMissionStartPhase3(string seq, string missionName)
            {
            onPhase2Complete();
            Util.StartClientReplication();
            Util.StartFoliageReplication();
            // Load the static mission decals.
            console.Call("decalManagerLoad", new[] { missionName + ".decals" });
            console.print("*** Phase 3: Mission Lighting");
            sGlobal["$MSeq"] = seq;
            sGlobal["$Client::MissionFile"] = missionName;
            // Need to light the mission before we are ready.
            // The sceneLightingComplete function will complete the handshake 
            // once the scene lighting is done.
            if (!Util.lightScene("sceneLightingComplete", ""))
                return;
            console.print("Lighting mission....");
            Util._schedule("1", "0", "updateLightingProgress");
            onMissionDownloadPhase3();
            bGlobal["$lightingMission"] = true;
            }

        [Torque_Decorations.TorqueCallBack("", "", "updateLightingProgress", "()", 0, 52000, false)]
        public void updateLightingProgress()
            {
            onPhase3Progress(console.GetVarString("$SceneLighting::lightingProgress"));
            if (bGlobal["$lightingMission"])
                iGlobal["$lightingProgressThread"] = Util._schedule("1", "0", "updateLightingProgress");
            }

        [Torque_Decorations.TorqueCallBack("", "", "sceneLightingComplete", "()", 0, 52000, false)]
        public void sceneLightingComplete()
            {
            console.print("Mission lighting done");
            onPhase3Complete();
            // The is also the end of the mission load cycle.
            onMissionDownloadComplete();
            console.commandToServer("MissionStartPhase3Ack", new[] { console.GetVarString("$MSeq") });
            }

        //----------------------------------------------------------------------------
        // Helper functions
        //----------------------------------------------------------------------------
        [Torque_Decorations.TorqueCallBack("", "", "connect", "(%server)", 1, 52000, false)]
        public void connect(string server)
            {
            iGlobal["$pref::Net::PacketRateToServer"] = 32;
            iGlobal["$pref::Net::PacketSize"] = 200;
            iGlobal["$platform::timeManagerProcessInterval"] = 1;
            coGameConnection conn = new Torque_Class_Helper("GameConnection", "ServerConnection").Create().AsString();
            ((coSimSet)"rootgroup").pushToBack(conn);
            conn.setConnectArgs(sGlobal["$pref::Player::Name"]);
            conn.setJoinPassword(sGlobal["$Client::Password"]);
            conn.connect(server);
            }
        }
    }